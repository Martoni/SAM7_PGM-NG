#! /usr/bin/perl

# AT91SAM7 Programmer, http://www.pjrc.com/arm/sam7_pgm
# Copyright (c) 2005, PJRC.COM, LLC, <paul@pjrc.com>
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; version 2
# of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.


$name = $ARGV[0];
$name or die "Usage: armlst2c <name>\n";

$NAME = uc($name);

open LST, "$name.armlst" or die "Unable to read $name.armlst\n";

$h = '[0-9A-Fa-f]';
$n = 0;
while (<LST>) {
	next unless /^\s*$h+:\s+($h$h)($h$h)($h$h)($h$h)/;
	$data[$n++] = "0x$4";
	$data[$n++] = "0x$3";
	$data[$n++] = "0x$2";
	$data[$n++] = "0x$1";
}
close LST;


open H, ">$name.h" or die "unable to write name.h\n";
print H "/* automatically generated by armlst2c */\n";
print H "#define ${NAME}_SIZE $n\n";
print H "extern unsigned char ${name}[${NAME}_SIZE];\n";
close H;

open C, ">$name.c" or die "unable to write $name.c\n";
print C "/* automatically generated by armlst2c */\n";
print C "#include \"$name.h\"\n";
print C "unsigned char ${name}[${NAME}_SIZE] = {\n";
for ($i=0; $i<@data; $i++) {
	print C "\t" if ($i % 8 == 0);
	print C $data[$i];
	print C ", " if ($i < @data - 1);
	print C "\n" if ($i % 8 == 7);
}
print C "};\n";
close C;


